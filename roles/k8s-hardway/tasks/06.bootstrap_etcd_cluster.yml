- block:
  - name: Copy etcd and etcdctl into remote server
    copy:
      src: "k8s_components/{{ item }}"
      dest: "/usr/local/bin"
      mode: "0500"
    loop:
      - etcd
      - etcdctl

  - name: Render etcd.service file
    template:
      src: "units/etcd.service.j2"
      dest: "/etc/systemd/system/etcd.service"

  - name: Create etcd directory
    file:
      path: "{{ item }}"
      state: "directory"
      owner: root
      group: root
      mode: "0700"
    loop:
      - /etc/etcd
      - /var/lib/etcd

- block:
  - name: Copy etcd certs to master
    copy:
      src: 'certs/{{ item }}'
      dest: '/etc/etcd'
    loop:
      - ca.crt
      - kube-api-server.key
      - kube-api-server.crt 

- block:
  - name: Reload systemd daemon
    systemd:
      daemon_reload: true
  - name: Enable and start etcd
    systemd:
      name: etcd
      state:  restarted
      enabled: true
